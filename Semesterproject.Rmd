---
title: Check how to Schreck
subtitle: Semesterproject of the module PTED FS 22
author: Fabienne Gräppi and Benjamin Bar-Gera
output: html_document

---


<!-- You can add  your R Code with Code chunks-->

```{r, echo = FALSE, warning=FALSE, message=FALSE}

# You can set chunk options individually per code chunk, as was done with this
# code chunk.

# echo = FALSE           hides the code from the generated output
# warning = FALSE        hides warnings from the generated output
# message = FALSE        hides messages from the generated output

# To set the setting for all code chunks, use the following code:

knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

```


# Abstract

<!-- the following is just a placeholder text, remove it!-->
Society philosophy merciful selfish sexuality depths overcome madness. Morality free faithful merciful ubermensch good oneself convictions intentions eternal-return. Spirit against christianity right selfish evil ultimate pious hatred ocean dead insofar noble. Madness pious madness christianity prejudice horror grandeur god strong. Ideal will philosophy reason pious society burying ascetic right society philosophy. Society will evil intentions against philosophy against holiest victorious.


# Introduction

Since almost going extinct in some parts of Europe the population of wild boars (Sus scrofa) has increased strongly ^1,2^, and they are now the fifth largest ungulated species in Europe ^3,4^. The increase of population in Europe has had significant influence on the biodiversity in forests and an economic impact on cultivated areas due to damage in in crop fields and transmission of diseases on domestic animals3. In Switzerland the damages from wild boars to cultivated areas cumulate to several million CHF a year ^5^. In order to reduce damage from wild boars in Switzerland, the Federal environmental agency (Bundesamt für Umwelt/BAFU) has released a document with tips and guidelines for the regulation of wild boar management and damage prevention. Measures described in the guideline include population control through hunting, employment of damage reducing actions, such as the use of electrical fences around cultivated areas or dissuasive feeding and the appropriate reimbursement for damages ^2,6,7^. Hunting to reduce population might be the most effective way to reduce damages but it can also have a negative impact on the living environment of other animals or plants and is highly time as well as work intensive ^4,6,7^. Other measures such as electrical fencing are sometimes also time intensive and costly to install. However, adequate defending measures are needed in the future as with population growth and the increasing distribution of wild boars, the pressure on agricultural land will continue to increase.  Due to the drawbacks of the described measures cheaper and less time and work consuming instruments have been tested such as acoustic scaring offs1. Wild boars have a keen sense of hearing and communicate with each other with warning sounds when they sense danger ^8^. This characteristic can be exploited to keep wild boars away from agricultural land by means of an acoustic scare device. This involves playing wild boar warning sounds at intervals.

Previous studies at the Department WILMA (Wildtiermanagement) at the ZHAW have demonstrated a reduction in damage to agricultural crops. In addition, the effectiveness of acoustic wild boar scare offs should be analyzed in terms of their impact on the spatial behavior of wild boars.

## Aim of the Study and Research Questions 

This present study is developed within the module Patterns and Trends in environmental Data (PTED 22). The effectiveness of the acoustic wild boar scare off systems is to be investigated on the basis of the spatial behavior of wild boars. In the course of this, gps location data of wild boars with different sampling intervals over a period of about 2 years and data sets of scare off location and agenda were provided. The area of interest in this study is the Fanel region at the western end of Lake Neuchâtel.

The aims of this study is to answer the following research questions:
- How effective are the Wildschwein-Schreck (WS) at keeping away wild boar and how long do these effects last?
- What settings (mode, noise level, interval, azimuth) and setting-combintations are most effective at keeping away wild boar?

# Material and Methods
## Data and Packages
Following R-Packages were used for the data processing and analysis:

- ComputationalMovementAnalysisData
- tidyverse
- sf
- leaflet
- leaflet.extras2
- gganimate
- ggspatial
- cowplot
- knitr
- multcompView

```{r, echo = FALSE, warning=FALSE, message=FALSE}
library(tidyverse)
library(ComputationalMovementAnalysisData)
library(sf)
library(leaflet)
library(leaflet.extras2)
library(gganimate)
library(ggspatial)
library(cowplot)
library(knitr)
library(multcompView)
```

Data used for this project was provided from our module supervisors. We used a dataset of wild boar GPS locations with time stamps (*Table 1*; wildschwein_BE), a set with the locations of the scare off (schreck) devices (*Table 2*; schreck_location) and a third set including the data when the schreck devices were on/off with additional information about their parameter settings. (*Table 3*; schreck_agenda). The wild boar location was sampled at 15 min intervals. while for the schreck events we know when they were turned on and off but have no further time information (in regards to their intervalls). The individual schreck settings can be adjusted for two different modes (standard v1 and aggressive v2), volume (a range of 33 - 100), interval (12.5 - 30), max. and min. orientation (0-330). We have access to all of that data as well.

*Table 1: Wild boar location data*
```{r}
kable(head(wildschwein_BE))
```

*Table 2: Schreck location data*
```{r}
kable(head(schreck_locations))
```

*Table 3: Schreck on/off, interval and parameter data*
```{r}
kable(head(schreck_agenda))
```
## Filter Data
Both the wildboar and the schreck data was filtered. The data was filtered for the relevant areas and time periods. As a first step, only wild boar location data within the closer proximity of the schreck locations was considered. Therefore, the data frames were transformed to sf objects and visually investigated (*Figure 1*) as well as cropped to the relevant area (*Figure 2*).

*Figure 1: Wild boar locations (blue) and schreck locations (red) uncropped*
```{r, echo = FALSE, warning=FALSE, message=FALSE}
# Convert data to sf formats
schreck_locations_sf <- st_as_sf(schreck_locations,
                                 coords = c("lon", "lat"),
                                 crs = 4326)
wildschwein_BE_sf <- st_as_sf(wildschwein_BE,
                                 coords = c("E", "N"),
                                 crs = 2056)
# Convert schreck_locations_sf from crs 4326 (WGS84) to crs 2056 (CH1903+ / LV95)
schreck_locations_sf <- st_transform(schreck_locations_sf, crs = 2056)

# Visualize the data (schreck and wildschwein locations)
ggplot() +
  geom_sf(data = wildschwein_BE_sf, colour = "blue") +
  geom_sf(data = schreck_locations_sf, colour = "red", alpha = 0.5) +
  annotation_scale() +
  coord_sf(datum=st_crs(2056))

# Crop both sf data frames (wildschwein & schreck locations) to only show area with significant overlap

wildschwein_BE_sf_cropped <- st_crop(wildschwein_BE_sf, xmin = 2560000, xmax = 2580000, ymin = 1200000, ymax = 1220000)
schreck_locations_sf_cropped <- st_crop(schreck_locations_sf, xmin = 2560000, xmax = 2580000, ymin = 1200000, ymax = 1220000)
```

*Figure 2: Wild boar locations (blue) and scare off locations (red) cropped*
```{r , echo = FALSE, warning=FALSE, message=FALSE}
ggplot() +
  geom_sf(data = wildschwein_BE_sf_cropped, colour = "blue") +
  geom_sf(data = schreck_locations_sf_cropped, colour = "red", alpha = 0.5) +
  annotation_scale() +
  coord_sf(datum=st_crs(2056))
```

Secondly, the two data frames for the schreck locations and the schreck agenda were joined to a single data frame and afterwards filtered according to the time when wild boar data was available. After filtering, 7 relevant schreck events and locations remain. Those are listed in *Table 4*.

*Table 4: Scare offs active within wild boar sampling period*
```{r, echo = FALSE, warning=FALSE, message=FALSE}
# First step: Join the schreck locations with the schreck events
schreck_agenda_and_locations <- schreck_locations_sf_cropped %>%
  left_join(schreck_agenda, by = "id")

# Filter Schreck-Agenda to the times when we have Wildschwein Data
schreck_agenda_and_locations_filtered <- schreck_agenda_and_locations %>%
  filter(
    datum_on > min(wildschwein_BE_sf_cropped$DatetimeUTC),
    datum_off < max(wildschwein_BE_sf_cropped$DatetimeUTC)
  )

# We do this to merge the two events each for WSS_2015_01, WSS_2015_03, WSS_2015_04...
schreck_agenda_and_locations_merged <- schreck_agenda_and_locations_filtered %>%
  group_by(id) %>%
  summarise(
    datum_on = min(datum_on),
    datum_off = max(datum_off)
  )
kable(schreck_agenda_and_locations_merged)
```

In order to be able to rule out the possibility that the schreck events somehow interacted with each other, we examined the physical and temporal distances between the schreck events and locations, as shown in *Figure 3*. Although schreck 2015_04 and 2016_06 are very close to each other (within a few meters), they were active in different years. Therefore, we assumed there is no mutual influence in terms of wild boar scare off.

*Figure 3: Scare off location overlap*
```{r, echo = FALSE, warning = FALSE, message = FALSE}
# Show how the circles lie over each other to determine whether to combine some Schreck-Locations
schreck_agenda_and_locations_merged_cricles <- st_buffer(schreck_agenda_and_locations_merged, 250)

ggplot() +
  geom_sf(data = schreck_agenda_and_locations_merged_cricles) +
  geom_sf(
    data = schreck_agenda_and_locations_merged, 
    mapping = aes(color = paste(id, "|", "on:", datum_on, "|", "off:", datum_off))
    ) +
  annotation_scale() +
  coord_sf(datum=st_crs(2056)) +
  labs(color = 'Schreck ID | Date On | Date Off', title = "Radius: 250 m")
```

```{r, message = FALSE, warning = FALSE}
# Create function that can automatically draw a denstiy plot for a specific schreck location 
# & specify number of days before and after schreck event that should appear on plot
# & specify the radii around schreck location
draw_density_plot <- function(schreck_id, radii, days_before, days_after) {
  # Filter schreck agenda to specific schreck
  specific_schreck <- schreck_agenda_and_locations_merged %>%
    filter(id == schreck_id)
  
  # Filter all wildschwein points by date to only ones occuring within above-mentioned schreck event (7 days before, during and 21 days after)
  specific_schreck_wildschwein <- wildschwein_BE_sf_cropped %>%
    filter(
      DatetimeUTC > as.Date(specific_schreck$datum_on) - days_before,
      DatetimeUTC < as.Date(specific_schreck$datum_off) + days_after
    )
  
  # For each radius (x) in radii... (this creates a vector with one SF data frame per radius in radii)
  schreck_specific_wildschwein_points <- radii %>% map(
    .f = function(x){
      # ... Create a circle / buffer with radius x around schreck 
      circle <- st_buffer(specific_schreck, x)
      # ... Filter all date-relevant wildschwin points to the ones in circle with radius x
      pigs_in_circle <- st_filter(specific_schreck_wildschwein, circle)
      # ... Add some convenience variables (radius and date) in order to visualize the density plots
      pigs_in_circle <- pigs_in_circle %>%
        mutate(
          radius = as.factor(x),
          date = as.Date(DatetimeUTC)
        )
      # ... return SF Data frame with the relevant pigs for radius x
      return(pigs_in_circle)
    }
  )
    # Combine all the SF data frames in schreck_specific_wildschwein_points to a singular data frame with variable 'radius'
  combined_wildschwein_points <- bind_rows(schreck_specific_wildschwein_points)
  
  
  # Plot the number of wildschwein per day within each schreck buffer for the specified dates
  combined_wildschwein_points %>%
    ggplot() +
    geom_density(mapping = aes(x = date, color = radius)) +
    # Then add 2 lines to signify start and end off schreck event
    geom_vline(xintercept =  as.Date(specific_schreck$datum_on), linetype="dotted", color = "blue", size = 1.5) +
    geom_vline(xintercept =  as.Date(specific_schreck$datum_off), linetype="dotted", color = "blue", size = 1.5) +
    labs(
      title = schreck_id, 
      subtitle = paste(
        "GPS Points:", nrow(combined_wildschwein_points),
        "|",
        "Duration:", (difftime(as.Date(specific_schreck$datum_off), as.Date(specific_schreck$datum_on), units = "days")),
        "days"
      )
    )
}
```

Additionally, for the statistical approaches we had to neglect two scare offs. WSS_2016_06 provides only 11 GPS points within a scare off duration of 30 days (with 10 days before and 14 days after the scare off event and a buffer zone with a radius of 500m around the scare off location) and WSS_2016_03 was active only for 5 days which is not comparable to the other scare off events.

```{r, echo = FALSE, warning=FALSE, message=FALSE}
WSS_2015_01_plot <- draw_density_plot("WSS_2015_01", c(500), 10, 14)

WSS_2015_03_plot <- draw_density_plot("WSS_2015_03", c(500), 10, 14)

WSS_2015_04_plot <- draw_density_plot("WSS_2015_04", c(500), 10, 14)

WSS_2016_01_plot <- draw_density_plot("WSS_2016_01", c(500), 10, 14)

WSS_2016_05_plot <- draw_density_plot("WSS_2016_05", c(500), 10, 14)

WSS_2016_06_plot <- draw_density_plot("WSS_2016_06", c(500), 10, 14)

WSS_2016_13_plot <- draw_density_plot("WSS_2016_13", c(500), 10, 14)

plot_grid(WSS_2015_01_plot, WSS_2015_03_plot, WSS_2015_04_plot, WSS_2016_01_plot, WSS_2016_05_plot, WSS_2016_06_plot, WSS_2016_13_plot, ncol = 2)
```
 
 
## Data Analysis for Research Question 1
To get an impression if the scare offs influences the occurrence of wild boars and how is the range of the effect, we designed a function. The function `draw_density_plot(schreck_id, radii, days_before, days_after)` is used to filter the data by observation radius and time for one scare off to then plot it as a density function. Thereby, the time period of days before and after the event can be set, while the time period during the event is given by the scare off agenda. 

# Results
## Research Question 1: Effect of scare off on wild boar occurance
The wild boar occurence shows different patterns for each scare off event ( *Figure 3*). The number of GPS point for each event ranges from 178 (WSS_2016_05) to above 10'000 points (WSS_2016_05). For WSS_2015_01, WSS_2015_03, and  WSS_2015_04 we observe the contrary pattern of what we expected, the occurrence increases during the first half of the event and then begins to decrease. The occurrence change is very similar when considering 100m, 200m or 400m radius. However the amplitude decreases with larger radius. WSS_2016_01 and WSS_2016_05 follow more the expected pattern, but the difference of the number of GPS points is high. For those scare off we observe higher amplitudes for smaller radius. While for WSS_2016_05 the size of the radius has low impact on the observation, it has a great impact in for WSS_2016_01 observation.
In a further step of exploratory data analysis we created interactive maps for two scare off events: one with the expected results (*Map 2*) and on with the opposite results (*Map 2*).

*Figure 3: Density plots for each scare off event, 10 days before and 14 days after event*

```{r, echo = FALSE, warning=FALSE, message=FALSE}
WSS_2015_01_plot <- draw_density_plot("WSS_2015_01", c(100, 200, 400), 10, 14)

WSS_2015_03_plot <- draw_density_plot("WSS_2015_03", c(100, 200, 400), 10, 14)

WSS_2015_04_plot <- draw_density_plot("WSS_2015_04", c(100, 200, 400), 10, 14)

WSS_2016_01_plot <- draw_density_plot("WSS_2016_01", c(100, 200, 400), 10, 14)

WSS_2016_05_plot <- draw_density_plot("WSS_2016_05", c(100, 200, 400), 10, 14)

WSS_2016_06_plot <- draw_density_plot("WSS_2016_06", c(100, 200, 400), 10, 14)

WSS_2016_13_plot <- draw_density_plot("WSS_2016_13", c(100, 200, 400), 10, 14)

plot_grid(WSS_2015_01_plot, WSS_2015_03_plot, WSS_2015_04_plot, WSS_2016_01_plot, WSS_2016_05_plot, nrow = 3)
```

*Map 1: Wild boar location of WSS_2015_01 scare off, 10 days before, during, and 14 days after event*
```{r, echo = FALSE, warning=FALSE, message=FALSE}
# The reason why we imported the leaflet widgets as html files, instead of running the code in the markdown file has do to with the fact that the leaflet timeslider seems to fail when we present more than 1 interactive map. If you want to see how these maps are generated, please have a look at the Semesterproject.R file (generate_interactive_map)
knitr::include_url("p_WSS_2015_01.html")
```

*Map 2: Wild boar location of WSS_2016_01 scare off, 10 days before, during, and 14 days after event*
```{r, echo = FALSE, warning=FALSE, message=FALSE}
knitr::include_url("p_WSS_2016_01.html")
```

*Box Plot with Tukey's Post-Hoc Test (ANOVA) 1: Number of GPS locations per day within the buffer zon before, during and after the scheck event*
```{r, echo = FALSE, warning=FALSE, message=FALSE}
  # Extract labels and factor levels from Tukey post-hoc 
  generate_label_df <- function(tukey, variable){
    Tukey.levels <- tukey[[variable]][,4]
    Tukey.labels <- data.frame(multcompLetters(Tukey.levels)['Letters'])
    Tukey.labels$period = rownames(Tukey.labels)
    Tukey.labels = Tukey.labels[order(Tukey.labels$period) , ]
    return(Tukey.labels)
  }

  # Function which generates model, anova, post-hoc tukey test and a boxplot for specified schreck and radius
  anova_for_schreck <- function(schreck_id, radius) {
    
    # Filter schreck agenda to specific schreck
    specific_schreck <- schreck_agenda_and_locations_merged %>%
        filter(id == schreck_id)
    
    # Create buffer zone with radius around specific schreck
    specific_schreck_circle <- st_buffer(specific_schreck, dist = radius)
    
    # Filter out only the wild boar within the buffer zone
    wildschwein_in_circle <- wildschwein_BE_sf_cropped %>%
      st_filter(specific_schreck_circle) %>%
      mutate(
        date = as.Date(DatetimeUTC),
        period = 
          ifelse(DatetimeUTC < specific_schreck_circle$datum_on, "BEFORE", 
                 ifelse(DatetimeUTC > specific_schreck_circle$datum_off, "AFTER", 
                        "DURING")))
    
    # Group the gps points by day
    wildschwein_per_day <- wildschwein_in_circle %>%
      st_drop_geometry() %>%
      group_by(date, period) %>%
      summarise(
        total_per_day = n()
      )
    
    # Estimate the effect of the period on the number of WS GPS Points per day:
    model <- lm(wildschwein_per_day$total_per_day ~ wildschwein_per_day$period)
    anova <- aov(model)
    
    # Tukey test to study each pair of period:
    tukey <- TukeyHSD(x = anova, 'wildschwein_per_day$period', conf.level = 0.95)
    
    # Apply the function to the dataset
    labels <- generate_label_df(tukey , "wildschwein_per_day$period")
    
    wildschwein_per_day <- wildschwein_per_day %>%
      left_join(labels, by = "period")
    
    wildschwein_per_day <- wildschwein_per_day %>%
      mutate(
        period = factor(period, levels = c("BEFORE", "DURING", "AFTER")) 
      )
    
    gg_labels <- wildschwein_per_day %>%
      group_by(period, Letters) %>%
      summarise(
        height = max(total_per_day)
      )
    
    p <- wildschwein_per_day %>%
      ggplot() +
      geom_boxplot(mapping = aes(x = period, y = total_per_day)) +
      ylim(NA, 1.1 * max(wildschwein_per_day$total_per_day)) +
      labs(
        x = "Period in relation to Schreck Event",
        y = "# of GPS points within buffer zone per day"
      ) + 
      geom_text(data = gg_labels,
                aes(x = period, y = height, label = Letters),
                vjust = -1.5, hjust = "inward")
    
    returnedList <- list("model" = model, "anova" = anova, "wildschwein_per_day" = wildschwein_per_day, "plot" = p)
    
  }
```


*Schreck-ID: WSS_2016_01, Radius: 200m*
```{r, echo = FALSE, warning=FALSE, message=FALSE}
# Run above function for schreck WSS_2016_01
  WSS_2016_01_package <- anova_for_schreck("WSS_2016_01", 100)
  summary(WSS_2016_01_package$anova)
  WSS_2016_01_package$plot
```

*Schreck-ID: WSS_2016_05, Radius: 200m*
```{r, echo = FALSE, warning=FALSE, message=FALSE}
# Run above function for schreck WSS_2016_01
  WSS_2016_05_package <- anova_for_schreck("WSS_2016_05", 100)
  summary(WSS_2016_05_package$anova)
  WSS_2016_05_package$plot
```


```{r, echo = FALSE, warning=FALSE, message=FALSE}
  
  generate_static_maps <- function(schreck_id, radius, days_before, days_after) {
    specific_schreck <- schreck_agenda_and_locations_merged %>%
      # Filter schreck agenda to specific schreck
      filter(id == schreck_id)
    
    # Draw a circle around that schreck
    specific_schreck_circle <- st_buffer(specific_schreck, dist = radius)
    
    specific_schreck_wildschwein <- wildschwein_BE_sf_cropped %>%
      # Filter wildschwein points by date to only ones occuring within above-mentioned schreck event
      filter(
        DatetimeUTC > as.Date(specific_schreck$datum_on) - days_before,
        DatetimeUTC < as.Date(specific_schreck$datum_off) + days_after
      ) %>%
      # Filter the above-mentioned wildschwein points to ones within the schreck circle
      st_filter(specific_schreck_circle) %>%
      # Create a new convenience variable (date, without time) 
      mutate(
        date = as.Date(DatetimeUTC),
        period = 
          ifelse(DatetimeUTC < specific_schreck_circle$datum_on, "BEFORE", 
                 ifelse(DatetimeUTC > specific_schreck_circle$datum_off, "AFTER", 
                        "DURING")),
        period = factor(period, levels = c("BEFORE", "DURING", "AFTER"))
      )
    
    p <- ggplot() +
      geom_sf(data = specific_schreck_wildschwein, mapping = aes(color = as.factor(TierName))) +
      geom_sf(data = specific_schreck, shape = 22, size = 3, mapping = aes(fill = "Schreck Location")) +
      facet_grid(~ period) +
      theme(legend.position = "bottom") +
      scale_fill_manual("", breaks = "Schreck Location", values = "red") +
      guides(color = guide_legend(title = "Individual name"))
    
    return(p)
  }
```

*Static map (before, during, after): WSS_2015_01, radius = 200m, 10 days before until 10 days after schreck event*

```{r, echo = FALSE, warning=FALSE, message=FALSE}

WSS_2015_01_static_map <- generate_static_maps("WSS_2015_01", 200, 10, 10)
WSS_2015_01_static_map

```

*Static map (before, during, after): WSS_2016_01, radius = 200m, 10 days before until 10 days after schreck event*

```{r, echo = FALSE, warning=FALSE, message=FALSE}

WSS_2016_01_static_map <- generate_static_maps("WSS_2016_01", 200, 10, 10)
WSS_2016_01_static_map

```


To be continued
# Discussion
coming soon


# References

(1) 	Suter Forschungsgruppe Wildtiermanagement WILMA, S. Forschungsprojekt Prävention von Wildschweinschäden in Der Landwirtschaft.
(2) 	Thurfjell, H.; Ball, J. P.; Åhlén, P.-A.; Kornacher, P.; Dettki, H.; Sjöberg, K. Habitat Use and Spatial Patterns of Wild Boar Sus Scrofa (L.): Agricultural Fields and Edges. European Journal of Wildlife Research 2009, 55 (5), 517–523. https://doi.org/10.1007/s10344-009-0268-1.
(3) 	Geisser, H.; Reyer, H. The Influence of Food and Temperature on Population Density of Wild Boar (Sus Scrofa) in the Thurgau (Switzerland). Journal of Zoology 2005, 267 (1), 89–96. https://doi.org/10.1017/S095283690500734X.
(4) 	Geisser, H. Efficacy of Hunting, Feeding, and Fencing to Reduce Crop Damage by Wild Boars. https://doi.org/10.2193/0022-541X.
(5) 	Jagdstatistik. https://www.jagdstatistik.ch/de/statistics?tt=2&dt=0&at=0&st=0&dp=0&ar=GE&th=1&yr%5Bfrom%5D=2000&yr%5Bto%5D=2020&sp=350 (accessed 2022-06-22).
(6) 	Wildschweinmanagement – Lernen aus der Erfahrung anderer. https://www.admin.ch/gov/de/start/dokumentation/medienmitteilungen.msg-id-8817.html (accessed 2022-06-22).
(7) 	Thurfjell, H.; Spong, G.; Ericsson, G. Effects of Hunting on Wild Boar (Sus Scrofa) Behaviour. Wildlife Biology 2013, 19 (1), 87–93. https://doi.org/10.2981/12-027.
(8) 	Meynhardt H. Untersuchung Zur Akustischen, Olfaktorischen Und Visuellen Kommunikation Des Europäischen Wildschweines (Sus Scarofa L.). Beiträge für die Frorstwirtschaft 1980, 14 (2), 74–82.